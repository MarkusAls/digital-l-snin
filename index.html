<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        body {
            font-size: 23px;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Style for the QR scanner */
        #reader {
            width: 100%;
            border-radius:15px;
        }

        /* Styling for the result container */
        #searchResult {
            text-align: center;
        }

        /* Fullscreen box for success (green) and failure (red) */
        #grønnBoks, #rødBoks {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none; /* Start hidden */
            z-index: 9999; /* Make sure it appears on top */
        }

        #grønnBoks {
            background-color: green;
        }

        #rødBoks {
            background-color: red;
        }
    </style>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Strekkode Scan</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script> <!-- QR-scanner library -->
</head>
<body>
    <audio id="audio" preload="auto">
        <source src="scan.mp3" type="audio/mp3">
    </audio>

    <div>
        <div id="reader"></div> <!-- Camera feed for QR scanning -->
    </div>
    <div id="grønnBoks"></div>
    <div id="rødBoks"></div>

    <div id="searchResult">
        <p id="resultText">Skann en Strekkode for å sjekke Elev Id.</p>
    </div>
    <button id="startScanButton">Start Scanning</button> <!-- Button to start scanning -->
    

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDtx8J7NBELBdhWrPgiFyWrOtiMSYerJbo",
            authDomain: "test-b24b1.firebaseapp.com",
            databaseURL: "https://test-b24b1-default-rtdb.firebaseio.com",
            projectId: "test-b24b1",
            storageBucket: "test-b24b1.firebasestorage.app",
            messagingSenderId: "1058078158269",
            appId: "1:1058078158269:web:10ac5b50c413295e3636d4",
            measurementId: "G-1CWRF1Z6BQ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let foundKey = null; // Store the key for the found VISID
        let isScanning = false; // Flag to prevent scanning too frequently

        window.onload = startQRScanner;

        const audioElement = document.getElementById("audio");
        const startScanButton = document.getElementById("startScanButton");

        // Function to play the sound
        function playSound() {
            audioElement.currentTime = 0; // Reset to the start of the audio
            audioElement.play(); // Play the sound
        }

        // Function to simulate a click event (for the sound button)
        function simulateClickOnButton() {
            playSound();  // Play sound immediately when this function is called
        }

        // Start QR scanner after a user clicks the button
        startScanButton.addEventListener("click", function() {
            playSound(); // Play sound when the button is clicked
            startQRScanner(); // Start the QR scanner (or any scanning process you want)
        });

        // Start QR code scanner
        function startQRScanner() {
            const text = document.getElementById("resultText");

            // Simulate a click on the sound button
            simulateClickOnButton(); // Simulating the click on the sound button
            
            // Request camera access for QR scanning
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    // Camera access granted, initialize the scanner with the video feed
                    const html5QrCode = new Html5Qrcode("reader");

                    // Set up QR scanner options
                    html5QrCode.start(
                        { facingMode: "environment" }, // Use the rear camera
                        {
                            fps: 10, // Set FPS (frames per second)
                            qrbox: { width: window.innerWidth * 0.7, height: window.innerWidth * 0.37 }, // QR box size
                            numOfWorkers: 4, // Increase speed by using multiple workers
                        },
                        (decodedText) => {
                            console.log("QR Code scanned:", decodedText);
                            // Handle decoded text (e.g., search for VISID)
                            searchVISID(decodedText); 
                        },
                        (errorMessage) => {
                            console.warn("QR scan failed:", errorMessage);
                        }
                    ).catch((err) => {
                        console.error("Error starting QR scanner:", err);
                        text.innerText = "Error starting the scanner.";
                    });
                })
                .catch((error) => {
                    let errorMessage = "Camera access denied";
                    if (error.name === 'NotFoundError') {
                        errorMessage = "No camera found on the device.";
                    } else if (error.name === 'NotAllowedError') {
                        errorMessage = "App does not have camera access.";
                    }
                    text.innerHTML = errorMessage + ": " + error;
                });
        }

            const html5QrCode = new Html5Qrcode("reader");
            const qrBoxWidth = window.innerWidth; // Get full viewport width

            html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10, // Frames per second
                    qrbox: { width: window.innerWidth * 0.7, height: window.innerWidth * 0.37 }, // Set the QR box dimensions
                    numOfWorkers: 4, // Use multiple workers for faster processing
                    disableFlip: false, // Avoid automatic flipping if camera is inverted
                    experimentalFeatures: {
                        useBarCodeDetectorIfSupported: true // Use barcode detector if supported
                    }
                },
                (decodedText) => {
                    if (!isScanning) {
                        isScanning = true; // Block further scans temporarily
                        searchVISID(decodedText);

                        // Set a timeout before allowing the next scan
                        setTimeout(() => {
                            isScanning = false; // Allow scanning again
                        }, 5000); // Delay in milliseconds (e.g., 5000 ms = 5 seconds)
                    }
                },
                (errorMessage) => {
                    // Log scanning failure (if any)
                    console.warn("QR-skanning feilet:", errorMessage);
                }
            ).catch((err) => {
                console.error("Klarte ikke å starte QR-skanner:", err);
            })
        

        // Search for VISID in the Firebase database
        const searchVISID = (visid) => {
            const resultText1 = document.getElementById('resultText');

            database.ref('/').once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    let found = false;

                    if (data) {
                        for (const key in data) {
                            if (data[key].VISID == visid) {
                                found = true;
                                foundKey = key; // Store the key for later use

                                // Display student details
                                resultText1.innerHTML = `
                                    <strong>Fornavn:</strong> ${data[key].Fornavn} <br>
                                    <strong>Etternavn:</strong> ${data[key].Etternavn} <br>
                                    <strong>Elev Id:</strong> ${data[key].VISID} <br>`;
                                bekreftelse();
                            }
                        }
                    }

                    if (!found) {
                        resultText1.innerHTML = `<span style="color: red; ">✖ VISIDe ikke funnet!</span>`;
                        foundKey = null;
                    }
                })
                .catch((error) => {
                    console.error('Error searching VISID:', error);
                    resultText1.innerText = "Feil ved søk!";
                });
        }

        // Confirmation and registration logic
        function bekreftelse() {
            const resultText2 = document.getElementById('resultText');

            if (!foundKey) {
                resultText2.innerText = "Du må skanne en gyldig VISID først!";
                return;
            }

            database.ref(`/${foundKey}`).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val();

                    if (userData && userData.Status === true) {
                        resultText2.innerHTML += `<br><span style="color: red; font-size:30px; ">❌ Denne Elev Id-en er allerede registrert!</span>`;

                        // Display red box (failure)
                        document.getElementById("rødBoks").style.display = "block";
                        setTimeout(() => {
                            document.getElementById("rødBoks").style.display = "none";
                        }, 1000);
                        return;
                    }

                    // Update status only if it's false (unregistered)
                    if (userData.Status === false) {
                        database.ref(`/${foundKey}`).update({ Status: true })
                            .then(() => {
                                resultText2.innerHTML += `<br><span style="color: green; ">✔ Registrering fullført!</span>`;

                                // Display green box (success)
                                document.getElementById("grønnBoks").style.display = "block";
                                setTimeout(() => {
                                    document.getElementById("grønnBoks").style.display = "none";
                                }, 1000);
                            })
                            .catch(error => {
                                console.error('Feil ved oppdatering av Status:', error);
                                resultText2.innerHTML += `<br><span style="color: red;">✖ Kunne ikke oppdatere Status!</span>`;
                            });
                    }
                })
                .catch(error => {
                    console.error('Feil ved henting av data:', error);
                    resultText2.innerText = "Feil ved henting av data!";
                });
        }
    </script>
</body>
</html>
