<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        body {
            font-size: 23px;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            margin-top: 10px;
        }

        /* Style for the QR scanner */
        #reader {
            width: 100%; /* Use 100% width of the viewport */
            
        }

        /* Styling for the result container */
        #searchResult {
            text-align: center;
        }

        
    </style>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Strekkode Scan</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script> <!-- QR-skanner bibliotek -->
</head>
<body>

    <div>
        <div id="reader"></div> <!-- Kamera-feed for QR-skanning -->
    </div>

    <div id="searchResult">
        <p id="resultText">Skann en Strekkode for å sjekke Elev Id.</p>
    </div>

    <script>

        const requestFullScreen = async () => {
            let element = await document.documentElement;
            let requestMethod =
            element.requestFullScreen ||
            element.webkitRequestFullScreen ||
            element.mozRequestFullScreen ||
            element.msRequestFullScreen;
            if (requestMethod) {
            requestMethod.call(element);
            return true;
            } else if (typeof window.ActiveXObject !== "undefined") {
            let wscript = new ActiveXObject("WScript.Shell");
            if (wscript !== null) {
                wscript.SendKeys("{F11}");
                return true;
            }
            }
        }

        const lock = async () => {
            var myScreenOrientation = window.screen.orientation;
            myScreenOrientation.lock(myScreenOrientation.type);
            return true;
        }
        // Firebase konfigurasjon
        const firebaseConfig = {
            apiKey: "AIzaSyDtx8J7NBELBdhWrPgiFyWrOtiMSYerJbo",
            authDomain: "test-b24b1.firebaseapp.com",
            databaseURL: "https://test-b24b1-default-rtdb.firebaseio.com",
            projectId: "test-b24b1",
            storageBucket: "test-b24b1.firebasestorage.app",
            messagingSenderId: "1058078158269",
            appId: "1:1058078158269:web:10ac5b50c413295e3636d4",
            measurementId: "G-1CWRF1Z6BQ"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let foundKey = null; // Holder på nøkkelen til VISID vi finner
        
        window.onload = startQRScanner;

        let isScanning = false; // Flag to prevent scanning too frequently

        // Start QR-kodeskanner
        function startQRScanner() {
            const text = document.getElementById("resultText"); // Reference to the element where error will be displayed

            // Access the camera
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    // Kamera stream er nå tilgjengelig, kan brukes i html5-qrcode
                })
                .catch(error => {
                    // Håndtere feilmeldinger spesifikt
                    let errorMessage = "Kameratilgang nektet";
                    if (error.name === 'NotFoundError') {
                        errorMessage = "Ingen kamera funnet på enheten.";
                    } else if (error.name === 'NotAllowedError') {
                        errorMessage = "Appen har ikke tilgang til kameraet.";
                    }
                    text.innerHTML = errorMessage + ": " + error;
                });

            const html5QrCode = new Html5Qrcode("reader");

            // Calculate the width of 100vw in pixels
            const qrBoxWidth = window.innerWidth; // This gives you 100vw in pixels

            html5QrCode.start(
                { facingMode: "environment" }, // Use the back camera
                {
                    fps: 10, // Frames per second
                    qrbox: { width: qrBoxWidth, height: qrBoxWidth * 0.5 }, // Use 100vw for width and 50% of it for height
                    numOfWorkers: 4, // Use multiple workers for faster processing
                    disableFlip: false // Disable automatic flipping if the camera is inverted
                },
                (decodedText) => {
                    if (!isScanning) {
                        isScanning = true; // Block further scans temporarily
                        searchVISID(decodedText);
                        
                        // Set a timeout before allowing the next scan
                        setTimeout(() => {
                            isScanning = false; // Allow scanning again
                        }, 5000); // Delay in milliseconds (e.g., 1000 ms = 1 second)
                    }
                },
                (errorMessage) => {
                    // Only log the error if needed
                    if (errorMessage && !errorMessage.includes("No MultiFormat Readers")) {
                        console.warn("QR-skanning feilet:", errorMessage);
                    }
                }
            ).catch((err) => {
                console.error("Klarte ikke å starte QR-skanner:", err);
            });
        }

        // Funksjon for å søke etter VISID i databasen
        const searchVISID = (visid) => {
            const resultText1 = document.getElementById('resultText');

            database.ref('/').once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    let found = false;

                    if (data) {
                        for (const key in data) {
                            if (data[key].VISID == visid) {
                                found = true;
                                foundKey = key; // Lagre nøkkel for registrering senere

                                // Now only display Fornavn, Etternavn, and VISID (Elev Id)
                                resultText1.innerHTML = ` 
                                    <strong>Fornavn:</strong> ${data[key].Fornavn} <br>
                                    <strong>Etternavn:</strong> ${data[key].Etternavn} <br>
                                    <strong>Elev Id:</strong> ${data[key].VISID} <br>`;
                                bekreftelse();
                            }
                        }
                    }

                    if (!found) {
                        resultText1.innerHTML = `<span style="color: red; font-weight: bold;">✖ VISID ikke funnet!</span>`;
                        foundKey = null;
                    }
                })
                .catch((error) => {
                    console.error('Error searching VISID:', error);
                    resultText1.innerText = "Feil ved søk!";
                });
        }

        function bekreftelse() {
            const resultText2 = document.getElementById('resultText');

            if (!foundKey) {
                resultText2.innerText = "Du må skanne en gyldig VISID først!";
                return;
            }

            database.ref(`/${foundKey}`).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val();

                    if (userData && userData.Status === true) {
                        resultText2.innerHTML += `<br><span style="color: red; font-size:30px; font-weight: bold;">❌ Denne Elev Id-en er allerede registrert!</span>`;
                        return;
                    }

                    // Oppdater Status KUN hvis den er false
                    if (userData.Status === false) {
                        database.ref(`/${foundKey}`).update({ Status: true })
                            .then(() => {
                                resultText2.innerHTML += `<br><span style="color: green; font-weight: bold;">✔ Registrering fullført!</span>`;
                            })
                            .catch(error => {
                                console.error('Feil ved oppdatering av Status:', error);
                                resultText2.innerHTML += `<br><span style="color: red;">✖ Kunne ikke oppdatere Status!</span>`;
                            });
                    } else {
                        resultText2.innerHTML += `<br><span style="color: red; font-weight: bold;">❌ Status kan ikke endres!</span>`;
                    }
                })
                .catch(error => {
                    console.error('Feil ved henting av data:', error);
                    resultText2.innerHTML = "Feil ved henting av data!";
                });
        }
    </script>
</body>
</html>
