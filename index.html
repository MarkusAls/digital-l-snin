<script>
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDtx8J7NBELBdhWrPgiFyWrOtiMSYerJbo",
        authDomain: "test-b24b1.firebaseapp.com",
        databaseURL: "https://test-b24b1-default-rtdb.firebaseio.com",
        projectId: "test-b24b1",
        storageBucket: "test-b24b1.firebasestorage.app",
        messagingSenderId: "1058078158269",
        appId: "1:1058078158269:web:10ac5b50c413295e3636d4",
        measurementId: "G-1CWRF1Z6BQ"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let foundKey = null; // Store the key for the found VISID
    let isScanning = false; // Flag to prevent scanning too frequently
    let soundInterval = null; // Interval for sound control

    window.onload = startQRScanner;

    const sound = document.getElementById("audio");

    // Function to play sound and handle intervals
    function playSound() {
        document.getElementById("test").innerHTML = "Scanning..."; // Update text to indicate scanning
        sound.currentTime = 0; // Reset sound to start
        sound.play(); // Play the sound
    }

    // Start QR code scanner
    function startQRScanner() {
        const text = document.getElementById("resultText");
        // Play sound on start
        // Request camera access
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                // Camera access granted, can be used in the html5-qrcode
            })
            .catch(error => {
                let errorMessage = "Kameratilgang nektet";
                if (error.name === 'NotFoundError') {
                    errorMessage = "Ingen kamera funnet på enheten.";
                } else if (error.name === 'NotAllowedError') {
                    errorMessage = "Appen har ikke tilgang til kameraet.";
                }
                text.innerHTML = errorMessage + ": " + error;
            });

        const html5QrCode = new Html5Qrcode("reader");
        const qrBoxWidth = window.innerWidth; // Get full viewport width

        html5QrCode.start(
            { facingMode: "environment" },
            {
                fps: 10, // Frames per second
                qrbox: { width: window.innerWidth * 0.7, height: window.innerWidth * 0.37 }, // Set the QR box dimensions
                numOfWorkers: 4, // Use multiple workers for faster processing
                disableFlip: false, // Avoid automatic flipping if camera is inverted
                experimentalFeatures: {
                    useBarCodeDetectorIfSupported: true // Use barcode detector if supported
                }
            },
            (decodedText) => {
                if (!isScanning) {
                    playSound();
                    isScanning = true; // Block further scans temporarily
                    searchVISID(decodedText); // Search the database for the decoded VISID

                    // Set a timeout before allowing the next scan
                    setTimeout(() => {
                        isScanning = false; // Allow scanning again
                    }, 5000); // Delay in milliseconds (e.g., 5000 ms = 5 seconds)
                }
            },
            (errorMessage) => {
                // Log scanning failure (if any)
                console.warn("QR-skanning feilet:", errorMessage);
            }
        ).catch((err) => {
            console.error("Klarte ikke å starte QR-skanner:", err);
        });
    }

    // Search for VISID in the Firebase database
    const searchVISID = (visid) => {
        const resultText1 = document.getElementById('resultText');

        database.ref('/').once('value')
            .then((snapshot) => {
                const data = snapshot.val();
                let found = false;

                if (data) {
                    for (const key in data) {
                        if (data[key].VISID == visid) {
                            found = true;
                            foundKey = key; // Store the key for later use

                            // Display student details
                            resultText1.innerHTML = `
                                <strong>Fornavn:</strong> ${data[key].Fornavn} <br>
                                <strong>Etternavn:</strong> ${data[key].Etternavn} <br>
                                <strong>Elev Id:</strong> ${data[key].VISID} <br>`;
                            bekreftelse();

                            // Play sound on successful scan
                        }
                    }
                }

                if (!found) {
                    resultText1.innerHTML = `<span style="color: red;">✖ VISID ikke funnet!</span><br><br>
                        <strong>Skannet innhold:</strong> ${visid}`;
                    foundKey = null;
                }
            })
            .catch((error) => {
                console.error('Error searching VISID:', error);
                resultText1.innerText = "Feil ved søk!";
            });
    }

    // Confirmation and registration logic
    function bekreftelse() {
        const resultText2 = document.getElementById('resultText');

        if (!foundKey) {
            resultText2.innerText = "Du må skanne en gyldig VISID først!";
            return;
        }

        database.ref(`/${foundKey}`).once('value')
            .then((snapshot) => {
                const userData = snapshot.val();

                if (userData && userData.Status === true) {
                    resultText2.innerHTML += `<br><span style="color: red; font-size:30px; ">❌ Denne Elev Id-en er allerede registrert!</span>`;

                    // Display red box (failure)
                    document.getElementById("rødBoks").style.display = "block";
                    setTimeout(() => {
                        document.getElementById("rødBoks").style.display = "none";
                    }, 1000);
                    stopSound(); // Stop sound interval on failure
                    return;
                }

                // Update status only if it's false (unregistered)
                if (userData.Status === false) {
                    database.ref(`/${foundKey}`).update({ Status: true })
                        .then(() => {
                            resultText2.innerHTML += `<br><span style="color: green; ">✔ Registrering fullført!</span>`;

                            // Display green box (success)
                            document.getElementById("grønnBoks").style.display = "block";
                            setTimeout(() => {
                                document.getElementById("grønnBoks").style.display = "none";
                            }, 1000);
                            stopSound(); // Stop sound interval on success
                        })
                        .catch(error => {
                            console.error('Feil ved oppdatering av Status:', error);
                            resultText2.innerHTML += `<br><span style="color: red;">✖ Kunne ikke oppdatere Status!</span>`;
                        });
                }
            })
            .catch(error => {
                console.error('Feil ved henting av data:', error);
                resultText2.innerText = "Feil ved henting av data!";
            });
    }
</script>
